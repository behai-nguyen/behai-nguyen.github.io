---
layout: post
title: "Rust: PDFs ‚Äî Exploring Layout with Pango and Cairo"

description: At the conclusion of the fourth article, we mentioned that we would explore text layout using Pango and its associated libraries&#58; GNU FriBidi and CairoGraphics. In the fifth post, we described how to build and install these libraries on both Ubuntu and Windows. In this article, we finally explore them in practice. The focus is on true justification ‚Äî that is, both the left and right margins are flush, not ragged, much like the TeX typesetting system. We use the Vietnamese text file from the fourth article to generate a PDF of more than 150 pages. 

tags:
- Rust
- FFI
- HarfBuzz
- hb-shape
- hb-subset
- Unicode
- font subset
- PDF
- multilingual
- line breaking
- text layout
- layout
- Pango
- Cairo
---

*At the conclusion of the <a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout/#concluding-remarks" title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">fourth article</a>, we mentioned that we would explore text layout using <a href="https://www.gtk.org/docs/architecture/pango" title="Pango Library" target="_blank"><code>Pango</code></a> and its associated libraries: <a href="https://github.com/fribidi/fribidi" title="GNU FriBidi" target="_blank"><code>GNU FriBidi</code></a> and <a href="https://www.cairographics.org/" title="CairoGraphics" target="_blank"><code>CairoGraphics</code></a>. In the <a href="https://behainguyen.wordpress.com/2025/12/19/rust-pdfs-build-and-install-pango-and-associated-libraries/" title="Rust: PDFs ‚Äî Build and Install Pango and Associated Libraries" target="_blank">fifth post</a>, we described how to build and install these libraries on both Ubuntu and Windows. In this article, we finally explore them in practice. The focus is on <strong>true justification</strong> ‚Äî that is, both the left and right margins are flush, not ragged, much like the <a href="https://en.wikipedia.org/wiki/TeX" title="TeX typesetting system" target="_blank">TeX</a> typesetting system. We use the Vietnamese text file from the fourth article to generate a PDF of more than 150 pages.*

<h3>
ü¶Ä <a href="https://github.com/behai-nguyen/polyglot_pdf" title="Index of the Complete Series" target="_blank">Index of the Complete Series</a>.
</h3>

| ![156-feature-image.png](https://behainguyen.wordpress.com/wp-content/uploads/2025/12/156-feature-image.png) |
|:--:|
| *Rust: PDFs ‚Äî Exploring Layout with Pango and Cairo* |

<a id="repository-cloning"></a>
üöÄ The code for this post is in the following GitHub repository: 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango" 
title="Rust multilingual PDFs" target="_blank">pdf_03_pango</a>.

<a id="not-using-lopdf"></a>
‚ù∂ <strong>We Are Not Using the <a href="https://crates.io/crates/lopdf" 
title="lopdf: A Rust library for PDF document manipulation." target="_blank">
<code>lopdf</code></a> Crate</strong>

The <code>Pango</code> and <code>Cairo</code> libraries, along with their Rust bindings, 
are fully capable of creating multilingual PDFs ‚Äî including font subsetting and 
preserving text for copy‚Äëand‚Äëpaste. We do not need to implement any of that ourselves. 
However, PDFs generated by these libraries often contain more internal objects than 
those created with <code>lopdf</code>, resulting in larger file sizes. For the text file 
we are using, the resulting PDF is nearly 600 KB, almost twice the size of the PDF 
produced with <code>lopdf</code>.

<a id="the-pango-cairo-crates"></a>
‚ù∑ <strong>The <a href="https://www.gtk.org/docs/architecture/pango" title="Pango Library" 
target="_blank"><code>Pango</code></a> and <a href="https://www.cairographics.org/" 
title="CairoGraphics" target="_blank"><code>CairoGraphics</code></a> Crates</strong>

The code we study in this article needs to use the following crates:
<a href="https://crates.io/crates/cairo-rs" 
title="Cairo bindings" target="_blank"><code>cairo-rs</code></a>, 
<a href="https://crates.io/crates/pango-sys" 
title="FFI bindings to libpango" target="_blank"><code>pango-sys</code></a>,
<a href="https://crates.io/crates/pango" 
title="Rust Pango bindings" target="_blank"><code>pango</code></a>, and 
<a href="https://crates.io/crates/pangocairo" 
title="Rust PangoCairo bindings" target="_blank"><code>pangocairo</code></a>.
We rely on features across all of these crates to achieve what we need.
The final code uses every one of them. The crates with the <code>-sys</code> suffix 
expose the low‚Äëlevel <code>unsafe</code> FFI APIs, while the others provide 
safe‚ÄëRust abstractions.

<a id="units-and-coordinates"></a>
‚ù∏ <strong>Units and Coordinates</strong>

When using <a href="https://www.gtk.org/docs/architecture/pango" title="Pango Library" 
target="_blank"><code>Pango</code></a> and <a href="https://www.cairographics.org/" 
title="CairoGraphics" target="_blank"><code>CairoGraphics</code></a>, we work with 
different units and coordinate systems. It is essential to understand these differences; 
otherwise the code will look confusing.

<a id="pdf-unit-and-coordinate"></a>
‚ìµ <strong>PDF Units and Coordinates</strong>

We covered this in detail in an 
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout/#a4-page-geometry" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">earlier article</a>. Here is a quick recap:

‚óè A PDF unit is a PostScript point. <code>1 point = 1/72 inch</code> exactly.  
<code>1 inch = 25.4 mm</code>.

‚óè <code>0, 0</code> ‚Äî the bottom‚Äëleft corner of the page.

‚óè <code>595.22, 842</code> ‚Äî the top‚Äëright corner of an A4 page.

We will not work with PDF coordinates directly, but it is important to keep them in mind.

<a id="pango-units-and-coordinates"></a>
‚ì∂ <strong><code>Pango</code> Units and Coordinates</strong>

<code>Pango</code> uses its own unit system. To convert a PDF unit to a Pango unit, 
multiply by <code>pango::SCALE</code>. To convert from Pango units back to PDF units, 
divide by the same constant.

<code>Pango</code> uses screen-style coordinates:

‚óè <code>0, 0</code> ‚Äî the top‚Äëleft corner.

<a id="cairo-units-and-coordinates"></a>
‚ì∑ <strong><code>Cairo</code> Units and Coordinates</strong>

<code>Cairo</code> uses device units, which for PDF surfaces are the same as PDF units 
(PostScript points).

Regarding <code>Cairo</code>‚Äôs coordinate system:

‚óè It is <strong>top‚Äëleft</strong> for image surfaces.

‚óè It is <strong>bottom‚Äëleft</strong> for PDF surfaces. However, <code>PangoCairo</code> 
applies the necessary transformation so that we can work in a top‚Äëleft coordinate system.

For simplicity, we can think of its coordinate system as matching <code>Pango</code> ‚Äî 
top‚Äëleft origin:

‚óè <code>0, 0</code> ‚Äî the top‚Äëleft corner.

<a id="repository-layout"></a>
‚ùπ <strong>Repository Layout</strong>

üí° Please note: on both Windows and Ubuntu, I‚Äôm running Rust version 
<code>rustc 1.90.0 (1159e78c4 2025-09-14)</code>.

This is once again a one‚Äëoff project‚ÄîI don‚Äôt plan to update it in future development. 
I want to keep a log of progress exactly as it occurred. Future code may copy this and 
make changes to it. I‚Äôve placed the project under the 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango" 
title="Rust multilingual PDFs" target="_blank">pdf_03_pango</a> directory. 
The structure is:

```
.
‚îú‚îÄ‚îÄ build.rs
‚îú‚îÄ‚îÄ Cargo.toml
‚îú‚îÄ‚îÄ set_env.bat
‚îú‚îÄ‚îÄ src
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main_start.rs
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main_fully_justified.rs
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main_essay.rs
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main.rs
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ page_geometry.rs
‚îî‚îÄ‚îÄ text
    ‚îî‚îÄ‚îÄ essay.txt
```

<a id="repository-layout-desc"></a>
All four <code>main*.rs</code> modules under <code>src/</code> are self‚Äëcontained 
Rust programs written in the listed order to help me understand <code>Pango</code> and 
<code>Cairo</code> layout. The <code>text/essay.txt</code> file is the Vietnamese input 
text, which the last two <code>main*.rs</code> modules convert into a PDF document. We 
also used this text file in the 
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout/#repository-layout-desc" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">fourth article</a>. 
We discuss these modules in the listed order.

The <code>src/page_geometry.rs</code> is also copied from the fourth post, with some minor 
refactoring, all <code>f32</code> changed to <code>f64</code>. Please refer to 
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout/#pdf-page-geometry" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">this discussion</a> for more detail. 
üëâ Changing value for any margin in the <code>A4_DEFAULT_MARGINS</code> constant would 
change the layout of the text in the PDF.

<a id="path-env-var"></a>
üí° The code requires the <code>Pango</code>, <code>HarfBuzz</code>, <code>Cairo</code>,
etc. libraries. üêß On Ubuntu, all required libraries are globally recognised. ü™ü On Windows, 
I haven‚Äôt added the paths for libraries' DLLs to the <code>PATH</code> environment variable. 
In each new Windows terminal session, I run the following once:

```
set PATH=C:\PF\harfbuzz\dist\bin\;%PATH%
set PATH=C:\PF\vcpkg\installed\x64-windows\bin\;%PATH%
set PATH=C:\PF\pango\dist\bin;C:\PF\cairo-1.18.4\dist\bin;C:\PF\fribidi\dist\bin;%PATH%
```

Alternatively, you can simply run 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_02/set_env.bat" 
title="pdf_02/set_env.bat file" target="_blank"><code>set_env.bat</code></a>.  
After that, <code>cargo run</code> works as expected.

<a id="build-mod-rust-analyzer"></a>
‚ù∫ <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/build.rs" 
title="The pdf_03_pango/build.rs module" target="_blank">
<code>pdf_03_pango/build.rs</code></a> Module and Visual Studio Code 
<a href="https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer" 
title="rust-analyzer" target="_blank"><code>rust-analyzer</code></a> On Windows ü™ü</strong>

<a id="build-mod"></a>
‚ìµ <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/build.rs" 
title="The pdf_03_pango/build.rs module" target="_blank">
<code>pdf_03_pango/build.rs</code></a> Module</strong>

The crates <a href="#the-pango-cairo-crates">we are using</a> already ship with 
FFI definitions, so we do not need to generate a <code>bindings.rs</code> module as we 
did for <code>HarfBuzz</code> in earlier articles in 
<a href="https://github.com/behai-nguyen/polyglot_pdf" title="Index of the Complete Series" 
target="_blank">this series</a>. We only need to ensure that the linker can find the 
required <code>.lib</code> files. On Linux üêß this works out of the box, but on Windows ü™ü 
we must add the locations of these <code>.lib</code> files to the search paths.  
These are the reasons why the <code>pdf_03_pango/build.rs</code> module is so simple: 
most of the code has appeared in earlier articles and should be self‚Äëexplanatory.

<a id="rust-analyzer"></a>
‚ì∂ Visual Studio Code 
<a href="https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer" 
title="rust-analyzer" target="_blank"><code>rust-analyzer</code></a> On Windows ü™ü</strong>

I am developing on Windows. The crates <a href="#the-pango-cairo-crates">we are using</a> 
are designed to discover native libraries automatically using <code>pkg-config</code>. 
If <code>pkg-config</code> cannot locate the <code>.pc</code> files for the relevant 
libraries, <code>rust-analyzer</code> reports many errors, becomes unresponsive, and IDE 
autocomplete stops working.

To fix this, open the Windows <code>Environment Variables</code> editor and, under 
<code>User variables for &lt;logged user&gt;</code>, add a new variable 
<code>PKG_CONFIG_PATH</code> whose value includes:

```
C:\PF\pango\dist\lib\pkgconfig
C:\PF\cairo-1.18.4\dist\lib\pkgconfig
C:\PF\vcpkg\installed\x64-windows\lib\pkgconfig
C:\PF\harfbuzz\dist\lib\pkgconfig
C:\PF\fribidi\dist\lib\pkgconfig
```

üôè These paths reflect my installation. Your paths may differ, so adjust them accordingly.

After restarting Visual Studio Code, all errors disappear and 
<code>rust-analyzer</code> becomes responsive again.

<a id="main-start-mod"></a>
‚ùª <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main_start.rs" 
title="The pdf_03_pango/src/main_start.rs module" target="_blank">
<code>pdf_03_pango/src/main_start.rs</code></a> Module</strong>

The code starts by creating a 
<a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/cairo/struct.PdfSurface.html" 
title="cairo Struct PdfSurface" target="_blank"><code>cairo::PdfSurface</code></a>. 
We need to enable the <code>pdf</code> feature for the crate as follows:

<figure class="highlight"><pre><code class="language-toml" data-lang="toml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">16
</pre></td><td class="code"><pre><span class="nn">cairo-rs</span> <span class="o">=</span> <span class="p">{</span> <span class="py">version</span> <span class="p">=</span> <span class="s">"0.21.5"</span><span class="p">,</span> <span class="py">features</span> <span class="p">=</span> <span class="nn">["pdf"]</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

A4 page width and height are in PostScript points, 
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout/#a4-page-size" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">as discussed earlier</a>.

Next, we create a <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/cairo/struct.Context.html" title="cairo Struct Context" target="_blank"><code>cairo::Context</code></a>. We then create a <a href="https://gtk-rs.org/gtk-rs-core/stable/0.21/docs/pango/struct.Layout.html" title="pango Struct Layout" target="_blank"><code>pango::Layout</code></a> using the function <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/pangocairo/functions/fn.create_layout.html" title="pangocairo function create_layout" target="_blank"><code>pub fn pangocairo::create_layout(cr: &Context) -&gt; Layout</code></a>, which is where the text will be rendered.

Regarding the parameter passed to <code>layout.set_width((a4_default_content_width() * pango::SCALE as f64) as i32);</code>, please refer to <a href="#pango-units-and-coordinates"><code>Pango</code> Units and Coordinates</a>. For <code>cr.move_to(A4_DEFAULT_MARGINS.left, A4_DEFAULT_MARGINS.top);</code>, see <a href="#cairo-units-and-coordinates"><code>Cairo</code> Units and Coordinates</a>.

For other <code>pangocairo</code> functions, please see the <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/pangocairo/all.html" title="List of all items" target="_blank"><code>pangocairo</code> API listing</a>.

We must specify an appropriate font for <code>pango::Layout</code> using <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/pango/struct.FontDescription.html" title="pango Struct FontDescription" target="_blank"><code>pango::FontDescription</code></a>; otherwise Pango will choose a default font, which is unlikely to be correct for our text. We must also set alignment and wrap mode using <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/pango/enum.Alignment.html" title="pango Enum Alignment" target="_blank"><code>pango::Alignment</code></a> and <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/pango/enum.WrapMode.html" title="pango Enum WrapMode" target="_blank"><code>pango::WrapMode</code></a>.

In the code above, we can uncomment the longer multiline text and experiment with different alignments to observe how the layout changes. The text is right‚Äëragged with <code>Alignment::Left</code> and left‚Äëragged with <code>Alignment::Right</code>. To make both the left and right margins flush, we must use justification.

<a id="pango-justification"></a>
‚ùº <strong>On <code>Pango</code> Justification</strong>

The <code>Pango</code> library implements the <code>pango_layout_set_justify()</code> 
function <a href="https://docs.gtk.org/Pango/method.Layout.set_justify.html" 
title="Pango ‚ñ∂Ô∏è Layout ‚ñ∂Ô∏è set_justify" target="_blank">https://docs.gtk.org/Pango/method.Layout.set_justify.html</a>:

```C
void pango_layout_set_justify (
  PangoLayout* layout,
  gboolean justify
)
```

I am reproducing its official documentation below:

<div style="border:1px solid black; padding:1em;">
<p><strong>Description</strong></p>

<p>
Sets whether each complete line should be stretched to fill the entire width of the layout.
</p>

<p>
Stretching is typically done by adding whitespace, but for some scripts (such as Arabic), the justification may be done in more complex ways, like extending the characters.
</p>

<p>
Note that this setting is not implemented and so is ignored in Pango older than 1.18.
</p>

<p>
Note that tabs and justification conflict with each other: Justification will move content away from its tab-aligned positions.
</p>

<p>
The default value is <code>FALSE</code>.
</p>

<p>
Also see <a href="https://docs.gtk.org/Pango/method.Layout.set_justify_last_line.html" 
title="Pango ‚ñ∂Ô∏è Layout ‚ñ∂Ô∏è set_justify_last_line" target="_blank">pango_layout_set_justify_last_line()</a>.
</p>

<p><strong>Parameters</strong></p>

<p><code>justify</code></p>

<p>
<span style="padding-left:1em;"><em>Type</em>: <code>gboolean</code></span>
</p>

<p>
<span style="padding-left:1em;">Whether the lines in the layout should be justified.</span>
</p>
</div><br/>

The <code>pango_sys</code> crate 
<a href="https://docs.rs/pango-sys/0.21.5/pango_sys/fn.pango_layout_set_justify.html" 
title="Function pango_layout_set_justify" target="_blank">imports</a> this function as:

```rust
pub unsafe extern "C" fn pango_layout_set_justify(
    layout: *mut PangoLayout,
    justify: gboolean,
)
```

To call this function, we need to obtain the raw C pointer 
<code>*mut PangoLayout</code> from the safe-Rust <code>pango::Layout</code> wrapper.

The 
<a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/glib/translate/trait.ToGlibPtr.html" 
title="Trait ToGlibPtr" target="_blank"><code>ToGlibPtr</code></a> trait provides the 
necessary conversions from Rust wrapper types to C-compatible raw pointers for FFI calls. 
Since we do not want to take ownership of the underlying C object, the method 
<a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/glib/translate/trait.ToGlibPtr.html#tymethod.to_glib_none" 
title="glib::to_glib_none() method" 
target="_blank"><code>fn to_glib_none(&'a self) -&gt; Stash&lt;'a, P, Self&gt;</code></a> 
is the appropriate choice. The returned 
<a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/glib/translate/struct.Stash.html"
title="Struct Stash" target="_blank"><code>Stash</code></a> contains the raw pointer.

The following wrapper <code>struct</code>s ‚Äî thin layers around pointers to C objects ‚Äî all implement <code>ToGlibPtr</code>: <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/cairo/struct.Context.html" title="cairo Struct Context" target="_blank"><code>cairo::Context</code></a>, <a href="https://gtk-rs.org/gtk-rs-core/stable/0.21/docs/pango/struct.Layout.html" title="pango Struct Layout" target="_blank"><code>pango::Layout</code></a>, <a href="https://gtk-rs.org/gtk-rs-core/stable/latest/docs/pango/struct.FontDescription.html" title="pango Struct FontDescription" target="_blank"><code>pango::FontDescription</code></a>, and others. Therefore, <code>to_glib_none()</code> is available on all of them.

Calling <code>pango::Layout::to_glib_none()</code> returns 
<code>Stash&lt;*mut PangoLayout, Layout&gt;</code>.  
The first element, <code>*mut PangoLayout</code>, is the raw pointer required by 
<code>pango_layout_set_justify()</code>.  
In the next module, we apply this function to achieve full justification.

<a id="main-justified-mod"></a>
‚ùΩ <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main_fully_justified.rs" 
title="The pdf_03_pango/src/main_fully_justified.rs module" target="_blank">
<code>pdf_03_pango/src/main_fully_justified.rs</code></a> Module</strong>

This module is a copy of <code>pdf_03_pango/src/main_start.rs</code> 
<a href="#main-start-mod"><code>discussed above</code></a>, with a few lines of 
full‚Äëjustification code added. There are two possible implementation approaches; 
both produce fully justified text.

The first approach is to use an <code>unsafe</code> FFI call, lines 44‚Äì46:

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">44
45
46
</pre></td><td class="code"><pre>    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="nf">pango_layout_set_justify</span><span class="p">(</span><span class="n">layout</span><span class="nf">.to_glib_none</span><span class="p">()</span><span class="na">.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c">//</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">TRUE</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

The second approach is to define a new method <code>fn set_justify(&self, justify: bool)</code> on <a href="https://gtk-rs.org/gtk-rs-core/stable/0.21/docs/pango/struct.Layout.html" title="pango Struct Layout" target="_blank"><code>pango::Layout</code></a>. Internally, this method calls the <code>unsafe</code> <code>pango_layout_set_justify()</code> function. This implementation appears in <a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main_fully_justified.rs#L17-L27" title="The pdf_03_pango/src/main_fully_justified.rs module" target="_blank"><code>lines 17 to 27</code></a>. We can then call the new <code>set_justify()</code> method as follows:

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">43
44
45
46
</pre></td><td class="code"><pre>    <span class="n">layout</span><span class="nf">.set_justify</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="cm">/* unsafe {
        pango_layout_set_justify(layout.to_glib_none().0, 1); // 1 = TRUE
    } */</span>
</pre></td></tr></tbody></table></code></pre></figure>

The screenshot below shows the output PDF:

![156-01-full-justification.png](https://behainguyen.wordpress.com/wp-content/uploads/2025/12/156-01-full-justification.png)

<p style="clear:both;"></p>

<a id="main-essay-mods"></a>
‚ùæ <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main_essay.rs" 
title="The pdf_03_pango/src/main_essay.rs module" target="_blank">
<code>pdf_03_pango/src/main_essay.rs</code></a> and 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main.rs" 
title="The pdf_03_pango/src/main.rs module" target="_blank">
<code>pdf_03_pango/src/main.rs</code></a>
Modules</strong>

In these two modules we read the Vietnamese text file and produce a PDF of more than 
150 pages. The primary objective of the first module, 
<code>pdf_03_pango/src/main_essay.rs</code>, is to demonstrate page breaking. In the 
final module, <code>pdf_03_pango/src/main.rs</code>, we demonstrate adding page numbers.

üí° <strong>Important</strong>: Please keep the discussion on 
<a href="#units-and-coordinates">Units and Coordinates</a> in mind while reading this section.

<a id="main-essay-mod"></a>
‚ìµ <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main_essay.rs" 
title="The pdf_03_pango/src/main_essay.rs module" target="_blank">
<code>pdf_03_pango/src/main_essay.rs</code></a> Module</strong>

As before, this module is built upon 
<code>pdf_03_pango/src/main_fully_justified.rs</code> 
<a href="#main-justified-mod"><code>discussed above</code></a>.  
We begin by reading the entire text file into a string and giving the full text to 
<code>layout</code>. All natural blank lines are preserved by <code>Pango</code>.

Similar to the 
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout/#pdf-text-pdf-gen" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">page‚Äëgeneration loop</a> in the 
fourth post, we iterate through the lines, calculate how many vertical PostScript points 
each line occupies, and increase the running vertical total accordingly. When the running 
total exceeds the effective page height ‚Äî <code>a4_default_content_height()</code> ‚Äî we 
flush the current page and start a new one. The code should be self‚Äëexplanatory.

Note also that, unlike the previous programs where we hardcoded the line height to 
<code>18</code> PostScript points, this module determines <code>line_height</code> as:

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">66
67
</pre></td><td class="code"><pre>	<span class="k">let</span> <span class="p">(</span><span class="mi">_</span><span class="n">ink</span><span class="p">,</span> <span class="n">logical</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="nf">.extents</span><span class="p">();</span>
	<span class="k">let</span> <span class="n">line_height</span> <span class="o">=</span> <span class="n">logical</span><span class="nf">.height</span><span class="p">()</span> <span class="k">as</span> <span class="nb">f64</span> <span class="o">/</span> <span class="nn">pango</span><span class="p">::</span><span class="n">SCALE</span> <span class="k">as</span> <span class="nb">f64</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></figure>

This produces a more accurate result. It is also the correct approach when headers or 
other text use larger font sizes, since they naturally require more vertical space.

We observe the following about the PDF generated by this module:

‚óè Visually, the font size appears larger than in the PDF generated in the  
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">fourth post</a>, even though 
we use the same font program and the same size.

‚óè All URLs are subjected to the same line‚Äëbreaking calculations. In the  
<a href="https://behainguyen.wordpress.com/2025/12/07/rust-pdfs-basic-text-layout" 
title="Rust: PDFs ‚Äî Basic Text Layout" target="_blank">fourth post</a> we did not 
account for URLs, so they simply disappeared off the right side.

‚óè The screenshot below shows a single morpheme (<code>ti·∫øng</code>) being broken 
across pages:

![156-02-bad-break.png](https://behainguyen.wordpress.com/wp-content/uploads/2025/12/156-02-bad-break.png)

In the paper <a href="https://drive.google.com/file/d/1zJwcRZ6q9zWfTtEMclF3HuOAFKnXj3fP/view?usp=sharing" 
title="Breaking Paragraphs into Lines, the original paper by Knuth and Plass" 
target="_blank">Breaking Paragraphs into Lines</a>, Knuth and Plass discuss this issue 
at length: such breaks are undesirable. I am not aware of any <code>Pango</code> settings 
that address this yet.

Next, we look at adding page numbers...

<a id="main-mod"></a>
‚ì∂ <strong>The 
<a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main.rs" 
title="The pdf_03_pango/src/main.rs module" target="_blank">
<code>pdf_03_pango/src/main.rs</code></a> Module</strong>

As before, we build this module on top of <code>pdf_03_pango/src/main_essay.rs</code>, <a href="#main-essay-mod">discussed above</a>. All the existing code remains intact. We add two new helper methods: <a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main.rs#L32-L53" title="total_pages() helper method" target="_blank"><code>total_pages()</code></a> and <a href="https://github.com/behai-nguyen/polyglot_pdf/blob/main/pdf_03_pango/src/main.rs#L55-L76" title="page_number() helper method" target="_blank"><code>page_number()</code></a>.

The <code>page_number()</code> function prints the current page number onto the current page. The text‚Äôs Y coordinate is fixed. The X coordinate is calculated dynamically and depends on the width of the page‚Äënumber text (e.g., <code>1 of 155</code> vs <code>150 of 155</code>). The midpoint of the page‚Äënumber text is aligned with the midpoint of the effective page width. Changing <code>A4_DEFAULT_MARGINS.left</code> and/or <code>A4_DEFAULT_MARGINS.right</code> will also change the X coordinate.

The <code>total_pages()</code> function calculates and returns the total number of pages after line breaking has been completed. This function is essentially a copy of the page‚Äëgeneration loop; it should be self‚Äëexplanatory. I attempted to compute the total number of pages without iterating through the line collection, but the results were incorrect. This approach works, but it is slow. I am not yet sure whether a more efficient alternative exists.

The screenshot below shows the last page with a page number:

![156-03-last-page-with-number.png](https://behainguyen.wordpress.com/wp-content/uploads/2025/12/156-03-last-page-with-number.png)

As <a href="#not-using-lopdf">mentioned</a> previously, the size of these PDFs is much larger than the one generated using the <a href="https://github.com/harfbuzz/harfbuzz" title="The HarfBuzz text shaping engine" target="_blank">HarfBuzz</a> library and the <a href="https://crates.io/crates/lopdf" title="lopdf: A Rust library for PDF document manipulation." target="_blank"><code>lopdf</code></a> crate. <a href="https://pdfxplorer.dev/" title="PDFXplorer" target="_blank">PDFXplorer</a> shows that there are many more internal objects: for example, more metadata, more structure, and more glyph tables.

<a id="concluding-remarks"></a>
‚ùø <strong>What‚Äôs Next</strong>

We have now completed an introductory exploration of 
<a href="https://www.gtk.org/docs/architecture/pango" title="Pango Library" 
target="_blank">Pango</a> and 
<a href="https://www.cairographics.org/" title="CairoGraphics" target="_blank">CairoGraphics</a>. 
I must admit, they are a joy to use. These libraries do not know anything about headers 
or similar structural elements; if we want to support those, we must implement them 
ourselves. I would like to explore this in the future.

I am not yet sure what my final goal with this study will be. One idea I find appealing 
is a reporting engine that generates business reports based on SQL queries, database 
connections, and a report template ‚Äî though that is still a long way off. Another idea: 
Facebook often has information‚Äërich posts in both English and Vietnamese, and it would be 
useful to have a CLI tool that takes a Facebook post‚Äôs URL and produces a nicely formatted 
PDF. I may explore this as well. Having said all this, at this point I am still not sure 
what the next post will be.

Thanks for reading! I hope this post helps others who are looking to deepen their 
understanding of PDF technology. As always‚Äîstay curious, stay safe ü¶ä

‚úø‚úø‚úø

Feature image sources:

<ul>
<li>
<a href="https://www.omgubuntu.co.uk/2024/03/ubuntu-24-04-wallpaper" target="_blank">https://www.omgubuntu.co.uk/2024/03/ubuntu-24-04-wallpaper</a>
</li>
<li>
<a href="https://in.pinterest.com/pin/337277459600111737/" target="_blank">https://in.pinterest.com/pin/337277459600111737/</a>
</li>
<li>
<a href="https://www.rust-lang.org/" target="_blank">https://www.rust-lang.org/</a>
</li>
<li>
<a href="https://www.pngitem.com/download/ibmJoR_rust-language-hd-png-download/" target="_blank">https://www.pngitem.com/download/ibmJoR_rust-language-hd-png-download/</a>
</li>
<li>
<a href="https://ur.wikipedia.org/wiki/%D9%81%D8%A7%D8%A6%D9%84:HarfBuzz.svg" target="_blank">https://ur.wikipedia.org/wiki/%D9%81%D8%A7%D8%A6%D9%84:HarfBuzz.svg</a>
</li>
<li>
<a href="https://en.wikipedia.org/wiki/Pango" target="_blank">https://en.wikipedia.org/wiki/Pango</a>
</li>
</ul>

<h3>
ü¶Ä <a href="https://github.com/behai-nguyen/polyglot_pdf" title="Index of the Complete Series" target="_blank">Index of the Complete Series</a>.
</h3>